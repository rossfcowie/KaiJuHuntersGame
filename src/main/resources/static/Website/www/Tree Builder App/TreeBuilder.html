<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Tree Builder</title>
    <link rel='stylesheet' id='theme_stylesheet'>
    <link rel='stylesheet' id='icon_stylesheet'>
    <style>[class*="foundicon-"] {font-family: GeneralFoundicons;font-style: normal;}</style>
    <style>.container{margin:2.5% !important; max-width:95%!important;}</style>
    <script src="https://cdn.jsdelivr.net/npm/@json-editor/json-editor/dist/jsoneditor.min.js"></script>
    <script src="js/jquery-3.4.1.min.js"></script>
    <script src="js/FileSaver.js"></script>
    <script src="js/fs.js"></script>
</head>

<body>
    <div class='container'>
        <div class='row'>
            <div class='span12 col-md-12 columns twelve large-12 col s12'>
                <h1>Tree Builder</h1>
                <div id='editor'></div>
            </div>
        </div>
        <div class='row'>
            <div class='span12 col-md-12 columns twelve large-12 col s12'>
                <h2>Techtree JSON Output</h2>
                <p>Put this into a Techtree.json file into you project/data folder.</p>
                <p>You can also make changes to the JSON here and set the value in the editor by clicking <button class='btn btn-primary' id='setvalue'>Update Form</button>.</p>
                <p><input id="myFile" type="file" accept=".json" style="display:none;" /><button class='btn btn-primary' id='loadFile'>Load File</button>&nbsp;<button class='btn btn-primary' id='saveFile'>Save File</button>&nbsp;<button style="display:none;" class='btn btn-primary' id='saveFileAs'>Save As</button></p>
                <textarea id='output' style='width: 100%; height: 300px; font-family: monospace;' class='form-control'></textarea>
                <h2 style="display:none;">Options</h2>
                <div id='options_holder' style="display:none;">
                    <div style="display:none">
                        <label>CSS Framework</label>
                        <select id='theme_switcher' class='form-control browser-default'>
                            <option value='bootstrap4'>Bootstrap 4</option>
                        </select>
                    </div>
                    <div style="display:none">
                        <label>Icon Library</label>
                        <select id='icon_switcher' class='form-control browser-default'>
                            <option value='fontawesome4'>FontAwesome 4</option>
                        </select>
                    </div>
                    <div>
                        <label>Object Layout</label>
                        <select id='object_layout' class='form-control browser-default'>
                            <option value='normal'>normal</option>
                            <option value='grid'>grid</option>
                        </select>
                    </div>
                    <div>
                        <label>Show Errors</label>
                        <select id='show_errors' class='form-control browser-default'>
                            <option value='interaction'>On Interaction</option>
                            <option value='change'>On Field Change</option>
                            <option value='always'>Always</option>
                            <option value='never'>Never</option>
                        </select>
                    </div>
                    <div>
                        <label>Boolean options</label>
                        <select multiple size="9" id="boolean_options" style="width: 100%; height: inherit;" class="form-control browser-default">
                            <option value='required_by_default'>Object properties required by default</option>
                            <option value='display_required_only'>Only show required properties by default</option>
                            <option value='no_additional_properties'>No additional object properties</option>
                            <option value='ajax'>Allow loading schemas via Ajax</option>
                            <option selected="selected" value='disable_edit_json'>Disable "Edit JSON" buttons</option>
                            <option value='disable_collapse'>Disable collapse buttons</option>
                            <option selected="selected" value='disable_properties'>Disable properties buttons</option>
                            <option value='disable_array_add'>Disable array add buttons</option>
                            <option value='disable_array_reorder'>Disable array move buttons</option>
                            <option value='disable_array_delete'>Disable array delete buttons</option>
                            <option value='disable_array_delete_all_rows'>Disable array delete all rows buttons</option>
                            <option value='disable_array_delete_last_row'>Disable array delete last row buttons</option>
                        </select>
                    </div>
                </div>
                <h2 style="display:none;">Validation</h2>
                <p style="display:none;">This will update whenever the form changes to show validation errors if there are any.</p>
                <textarea style="display:none;" id='validate' style='width: 100%; height: 100px; font-family: monospace;' readonly disabled class='form-control'></textarea>
            </div>
        </div>
        <div style="display:none;" class='row'>
            <div class='row'>
                <div class='span12 col-md-12 columns twelve large-12 col s12'>
                    <h2>Schema</h2>
                    <p>You can change the schema and see how the generated form looks. After you make changes, click <button class='btn btn-primary' id='setschema'>Update Schema</button></p>
                    <textarea id='schema' style='width: 100%; height: 450px; font-family: monospace;' class='form-control'></textarea>
                </div>
            </div>
        </div>
    </div>
    <script>
    (function() {
        var schema;
        if(window.location.href.match('[?&]schema=([^&]+)')) {
            try {
                schema = JSON.parse(LZString.decompressFromBase64(window.location.href.match('[?&]schema=([^&]+)')[1]));
            } catch (e) {
                console.log('invalid starting schema');
            }
        }

        // Default starting schema
        if(!schema) {
            schema = {
                title: 'Techtrees',
                type: 'array',
                format: 'tabs',
                uniqueItems: true,
                items: {
                    type: 'object',
                    title: 'Tree',
                    format: 'table',
                    properties: {
                        uid: {
                            type: 'string',
                            title: 'Unique Identifier'
                        },
                        header: {
                            type: 'string',
                            title: 'Header line'
                        },
                        tech_description: {
                            type: 'string',
                            title: 'Description'
                        },
                        icon: {
                            type: 'integer',
                            title: 'Icon Index'
                        },
                        bgimg: {
                            type: 'string',
                            title: 'Background Image File'
                        },
                        nodes: {
                            title: 'Techtree Nodes',
                            type: 'array',
                            format: 'table',
                            uniqueItems: true,
                            items: {
                                type: 'object',
                                properties: {
                                    technode: {
                                        type: 'object',
                                        title: 'Node',
                                        properties: {
                                            uid: {
                                                type: 'string',
                                                title: 'Unique Identifier'
                                            },
                                            lane: {
                                                type: 'integer',
                                                description: 'On which lane the tech should appear.',
                                                title: 'Lane'
                                            },
                                            depth: {
                                                type: 'integer',
                                                description: 'How deep into the tree the tech should appear.',
                                                title: 'Depth'
                                            },
                                            header: {
                                                type: 'string',
                                                title: 'Header line'
                                            },
                                            tech_description: {
                                                type: 'string',
                                                title: 'Description'
                                            },
                                            bgimg: {
                                                type: 'string',
                                                title: 'Background Image File Name'
                                            },
                                            parents: {
                                                type: 'array',
                                                format: 'table',
                                                title: 'Parents',
                                                uniqueItems: true,
                                                items: {
                                                    type: 'object',
                                                    title: 'Parent',
                                                    properties: {
                                                        parent: {
                                                            type: 'string',
                                                            description: 'Unique Identifiers of the parent nodes.'
                                                        }
                                                    }
                                                }
                                            },
                                            neededParents: {
                                                title: 'needed Parents',
                                                description: 'Amount of parents that need to be active for the node to be learnable.',
                                                type: 'integer',
                                                'default': 0
                                            },
                                            levelRequirement: {
                                                title: 'Level Requirement',
                                                description: 'Level the actor needs to unlock the node.',
                                                type: 'integer',
                                                'default': 0,
                                                required: true
                                            },
                                            visibility: {
                                                type: 'object',
                                                title: 'Visibility Requirements',
                                                description: 'Switches that need to be true for the node to be visible.',
                                                properties: {
                                                    switches: {
                                                        type: 'array',
                                                        format: 'table',
                                                        title: 'Visibility Requirement Switches',
                                                        uniqueItems: true,
                                                        items: {
                                                            type: 'object',
                                                            title: 'Switch',
                                                            properties: {
                                                                id: {
                                                                    type: 'integer',
                                                                    title: 'Switch ID'
                                                                }
                                                            }
                                                        }
                                                    }
                                                },
                                                options: {
                                                    collapsed: true
                                                }
                                            },
                                            costs: {
                                                type: 'object',
                                                title: 'Costs',
                                                properties: {
                                                    gold: {
                                                        type: 'integer',
                                                        title: 'Gold Cost'
                                                    },
                                                    jp: {
                                                        type: 'integer',
                                                        title: 'JP Cost',
                                                        description: 'Requires Yanflys Jobpoints.'
                                                    },
                                                    items: {
                                                        type: 'array',
                                                        format: 'table',
                                                        title: 'Item Costs',
                                                        uniqueItems: true,
                                                        items: {
                                                            type: 'object',
                                                            title: 'Item',
                                                            properties: {
                                                                id: {
                                                                    type: 'integer',
                                                                    title: 'Item ID'
                                                                },
                                                                amount: {
                                                                    type: 'integer',
                                                                    title: 'Amount'
                                                                }
                                                            }
                                                        },
                                                        options: {
                                                            collapsed: true
                                                        }
                                                    },
                                                    weapons: {
                                                        type: 'array',
                                                        format: 'table',
                                                        title: 'Weapon Costs',
                                                        uniqueItems: true,
                                                        items: {
                                                            type: 'object',
                                                            title: 'Weapon',
                                                            properties: {
                                                                id: {
                                                                    type: 'integer',
                                                                    title: 'Weapon ID'
                                                                },
                                                                amount: {
                                                                    type: 'integer',
                                                                    title: 'Amount'
                                                                }
                                                            }
                                                        },
                                                        options: {
                                                            collapsed: true
                                                        }
                                                    },
                                                    armors: {
                                                        type: 'array',
                                                        format: 'table',
                                                        title: 'Armor Costs',
                                                        uniqueItems: true,
                                                        items: {
                                                            type: 'object',
                                                            title: 'Armor',
                                                            properties: {
                                                                id: {
                                                                    type: 'integer',
                                                                    title: 'Armor ID'
                                                                },
                                                                amount: {
                                                                    type: 'integer',
                                                                    title: 'Amount'
                                                                }
                                                            }
                                                        },
                                                        options: {
                                                            collapsed: true
                                                        }
                                                    }
                                                }
                                            },
                                            onActivate: {
                                                type: 'object',
                                                title: 'On Activate',
                                                description: 'Effects that trigger when the node is learned by the player.',
                                                properties: {
                                                    switches: {
                                                        type: 'array',
                                                        format: 'table',
                                                        title: 'Changes to Switches',
                                                        uniqueItems: true,
                                                        items: {
                                                            type: 'object',
                                                            title: 'Switch Change',
                                                            properties: {
                                                                id: {
                                                                    type: 'integer',
                                                                    title: 'Switch ID'
                                                                },
                                                                value: {
                                                                    type: 'boolean',
                                                                    title: 'Value',
                                                                    'default': 'false'
                                                                }
                                                            }
                                                        },
                                                        options: {
                                                            collapsed: true
                                                        }
                                                    },
                                                    skills: {
                                                        type: 'array',
                                                        format: 'table',
                                                        title: 'Learn Skills',
                                                        uniqueItems: false,
                                                        items: {
                                                            type: 'integer',
                                                            title: 'Skill ID'
                                                        }
                                                    },
                                                    commonevents: {
                                                        type: 'array',
                                                        format: 'table',
                                                        title: 'Run Common Events',
                                                        uniqueItems: true,
                                                        items: {
                                                            type: 'object',
                                                            title: 'Common Event',
                                                            properties: {
                                                                id: {
                                                                    type: 'integer',
                                                                    title: 'Common Event ID',
                                                                    minimum: 1
                                                                },
                                                                close: {
                                                                    type: 'boolean',
                                                                    title: 'Close Scene On Activate',
                                                                    'default': 'false'
                                                                }
                                                            }
                                                        },
                                                        options: {
                                                            collapsed: true
                                                        }
                                                    },
                                                    animation: {
                                                        type: 'object',
                                                        title: 'Play Animation',
                                                        description: 'Animation played when this node is activated. Overwrites animation set for whole tree.',
                                                        properties: {
                                                            id: {
                                                                type: 'integer',
                                                                title: 'ID (1 to infinity)'
                                                            }
                                                        },
                                                        options: {
                                                            collapsed: true
                                                        }
                                                    },
                                                    stats: {
                                                        type: 'object',
                                                        title: 'Stat Changes',
                                                        required: true,
                                                        options: {
                                                            collapsed: true
                                                        },
                                                        properties: {
                                                            '0': {
                                                                type: 'integer',
                                                                required: true,
                                                                title: 'max HP'
                                                            },
                                                            '1': {
                                                                type: 'integer',
                                                                required: true,
                                                                title: 'max MP'
                                                            },
                                                            '2': {
                                                                type: 'integer',
                                                                required: true,
                                                                title: 'Attack'
                                                            },
                                                            '3': {
                                                                type: 'integer',
                                                                required: true,
                                                                title: 'Defense'
                                                            },
                                                            '4': {
                                                                type: 'integer',
                                                                required: true,
                                                                title: 'Magic Attack'
                                                            },
                                                            '5': {
                                                                type: 'integer',
                                                                required: true,
                                                                title: 'Magic Defense'
                                                            },
                                                            '6': {
                                                                type: 'integer',
                                                                required: true,
                                                                title: 'Agility'
                                                            },
                                                            '7': {
                                                                type: 'integer',
                                                                required: true,
                                                                title: 'Luck'
                                                            }
                                                        }
                                                    },
                                                    eval: {
                                                        type: 'object',
                                                        required: true,
                                                        title: 'Run Custom Javascript Code',
                                                        properties: {
                                                            onActivate: {
                                                                type: 'string',
                                                                required: true,
                                                                format: 'textarea',
                                                                title: 'Run custom JS code on node activation',
                                                                description: 'Scope is Game_Actor.'
                                                            },
                                                            onDeactivate: {
                                                                type: 'string',
                                                                required: true,
                                                                format: 'textarea',
                                                                title: 'Run custom JS code on node deactivation.',
                                                                description: 'Scope is Game_Actor. Should be used to revert the on activation part.'
                                                            }
                                                        },
                                                        options: {
                                                            collapsed: true
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        },
                        animation: {
                            type: 'object',
                            title: 'Play Animation',
                            description: 'Default animation played when a node is activated. Used for the whole tree.',
                            options: {
                                collapsed: true
                            },
                            properties: {
                                id: {
                                    type: 'integer',
                                    title: 'ID (1 to infinity)'
                                }
                            }
                        },
                        hideGoldCost: {
                            type: 'boolean',
                            required: true,
                            title: 'Don\'t show gold currency for this tree?',
                            'default': false
                        },
                        hideJPCost: {
                            type: 'boolean',
                            required: true,
                            title: 'Don\'t show Jobpoints (JP) as a currency for this tree?',
                            'default': false
                        },
                        costItems: {
                            type: 'array',
                            format: 'table',
                            required: true,
                            uniqueItems: true,
                            title: 'Main Cost Items',
                            description: 'IDs of the items shown in the top right cost window for this techtree.',
                            items: {
                                type: 'integer',
                                title: 'Item IDs'
                            },
                            options: {
                                collapsed: true
                            }
                        }
                    }
                }
            }
            console.log(JSON.stringify(schema));
        }

        // Divs/textareas on the page
        var $schema = document.getElementById('schema');
        var $output = document.getElementById('output');
        var $editor = document.getElementById('editor');
        var $validate = document.getElementById('validate');

        // Buttons
        var $set_schema_button = document.getElementById('setschema');
        var $set_value_button = document.getElementById('setvalue');

        var $myFile = document.getElementById('myFile');
        var $loadFile = document.getElementById('loadFile');
        var $saveFile = document.getElementById('saveFile');
        var $loadedPath = null;

        var jsoneditor;

        var updateDirectLink = function() {
            var url = window.location.href.replace(/\?.*/, '');

            url += '?schema=' + LZString.compressToBase64(JSON.stringify(schema));
            url += '&value=' + LZString.compressToBase64(JSON.stringify(jsoneditor.getValue()));

            for(var i in JSONEditor.defaults.options) {
                if(!JSONEditor.defaults.options.hasOwnProperty(i)) continue;
                if(JSONEditor.defaults.options[i] === false) continue;
                else if(JSONEditor.defaults.options[i] === true) {
                    url += '&' + i;
                } else {
                    url += '&' + i + '=' + JSONEditor.defaults.options[i];
                }
            }

            //document.getElementById('direct_link').href = url;
        };

        var reload = function(keep_value) {
            var startval = (jsoneditor && keep_value) ? jsoneditor.getValue() : window.startval;
            window.startval = undefined;

            if(jsoneditor) jsoneditor.destroy();
            jsoneditor = new JSONEditor($editor, {
                schema: schema,
                startval: startval
            });
            window.jsoneditor = jsoneditor;

            // When the value of the editor changes, update the JSON output and validation message
            jsoneditor.on('change', function() {
                var json = jsoneditor.getValue();

                $output.value = JSON.stringify(json, null, 2);

                var validation_errors = jsoneditor.validate();
                // Show validation errors if there are any
                if(validation_errors.length) {
                    $validate.value = JSON.stringify(validation_errors, null, 2);
                } else {
                    $validate.value = 'valid';
                }

                //updateDirectLink();

                // Materialize extra.
                if(window.Materialize) window.Materialize.updateTextFields();

            });
        };

        // Start the schema and output textareas with initial values
        $schema.value = JSON.stringify(schema, null, 2);
        $output.value = '';

        // When the 'update form' button is clicked, set the editor's value
        $set_value_button.addEventListener('click', function() {
            jsoneditor.setValue(JSON.parse($output.value));
        });

        // Update the schema when the button is clicked
        $set_schema_button.addEventListener('click', function() {
            try {
                schema = JSON.parse($schema.value);
            } catch (e) {
                alert('Invalid Schema: ' + e.message);
                return;
            }

            reload();
        });

        $("#myFile").change(function(event) {
            $loadedPath = null;
            var input = event.target;
            if(input) {
                $loadedPath = input;
                var reader = new FileReader();
                reader.onload = function() {
                    $output.value = reader.result;
                    jsoneditor.setValue(JSON.parse($output.value));
                };
                reader.readAsText(input.files[0]);
            };
        });

        $loadFile.addEventListener('click', function() {
            $myFile.click();
        });

        $saveFile.addEventListener('click', function() {
            var blob = new Blob([$output.value], { type: "text/json;charset=utf-8" });
            saveAs(blob, "Techtrees.json");
        });

        // Set the theme by loading the right stylesheets
        var setTheme = function(theme, no_reload) {
            theme = theme || '';

            var mapping = {
                barebones: '',
                html: '',
                bootstrap2: 'css/bootstrap.min.css',
                bootstrap3: 'css/bootstrap.min.css',
                bootstrap4: 'css/bootstrap.min.css',
                foundation3: 'css/bootstrap.min.css',
                foundation4: 'www.cdnjs.cloudflare.com/ajax/libs/foundation/4.3.2/css/foundation.min.css',
                foundation5: 'www.cdnjs.cloudflare.com/ajax/libs/foundation/5.5.3/css/foundation.min.css',
                foundation6: 'www.cdnjs.cloudflare.com/ajax/libs/foundation/6.2.4/foundation.min.css',
                jqueryui: 'www.code.jquery.com/ui/1.10.3/themes/south-street/jquery-ui.css',
                materialize: 'www.cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css'
            };

            if(typeof mapping[theme] === 'undefined') {
                theme = 'bootstrap3';
                document.getElementById('theme_switcher').value = theme;
            }

            var scriptMapping = {
                materialize: [
                    'https://code.jquery.com/jquery-3.2.1.min.js',
                    'https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js'
                ]
            }

            var themeScripts = scriptMapping[theme],
                head = document.getElementsByTagName('head')[0],
                script;

            if(typeof themeScripts == 'string') { themeScripts = [themeScripts]; }
            if(Array.isArray(themeScripts)) {
                for(var i = 0; i < themeScripts.length; i++) {
                    script = document.createElement('script');
                    script.type = 'text/javascript';
                    script.src = themeScripts[i];
                    head.appendChild(script);
                }
            }

            JSONEditor.defaults.options.theme = theme;
            //JSONEditor.defaults.options["disable_edit_json"] = true;
            //JSONEditor.defaults.options["disable_properties"] = true;
            JSONEditor.defaults.options.required_by_default = true;
            document.getElementById('theme_stylesheet').href = mapping[theme];
            document.getElementById('theme_switcher').value = JSONEditor.defaults.options.theme;

            if(!no_reload) reload(true);
        };

        // Set the icontheme
        // Set the theme by loading the right stylesheets
        var setIconlib = function(iconlib, no_reload) {
            iconlib = iconlib || '';
            var mapping = {
                foundation2: 'css/font-awesome.css',
                foundation3: 'css/font-awesome.css',
                fontawesome3: 'css/font-awesome.css',
                fontawesome4: 'css/font-awesome.css',
                materialicons: 'css/font-awesome.css'
            };

            JSONEditor.defaults.options.iconlib = iconlib;

            document.getElementById('icon_stylesheet').href = mapping[iconlib] || '';
            document.getElementById('icon_switcher').value = JSONEditor.defaults.options.iconlib;

            if(!no_reload) reload(true);
        };

        var refreshBooleanOptions = function(no_reload) {
            var boolean_options = document.getElementById('boolean_options').children;
            for(var i = 0; i < boolean_options.length; i++) {
                JSONEditor.defaults.options[boolean_options[i].value] = boolean_options[i].selected;
            }
            if(!no_reload) reload(true);
        };

        // Change listeners for options
        document.getElementById('theme_switcher').addEventListener('change', function() {
            setTheme(this.value);
        });
        document.getElementById('icon_switcher').addEventListener('change', function() {
            setIconlib(this.value);
        });
        document.getElementById('object_layout').addEventListener('change', function() {
            JSONEditor.defaults.options.object_layout = this.value;
            reload(true);
        });
        document.getElementById('show_errors').addEventListener('change', function() {
            JSONEditor.defaults.options.show_errors = this.value;
            reload(true);
        });
        document.getElementById('boolean_options').addEventListener('change', function() {
            refreshBooleanOptions();
        });

        /*
        // Get starting value from url
        if (window.location.href.match('[?&]value=([^&]+)')) {
            window.startval = JSON.parse(LZString.decompressFromBase64(window.location.href.match('[?&]value=([^&]+)')[1]));
        }
        */
        // Set options from direct link
        setTheme((window.location.href.match(/[?&]theme=([^&]+)/) || [])[1] || 'bootstrap4', true);

        setIconlib((window.location.href.match(/[?&]iconlib=([^&]*)/) || [null, 'fontawesome4'])[1], true);

        document.getElementById('object_layout').value = (window.location.href.match(/[?&]object_layout=([^&]+)/) || [])[1] || 'normal';
        JSONEditor.defaults.options.object_layout = document.getElementById('object_layout').value;

        document.getElementById('show_errors').value = (window.location.href.match(/[?&]show_errors=([^&]+)/) || [])[1] || 'interaction';
        JSONEditor.defaults.options.show_errors = document.getElementById('show_errors').value;

        var boolean_options = document.getElementById('boolean_options').children;
        for(var i = 0; i < boolean_options.length; i++) {
            if(window.location.href.match(new RegExp('[?&]' + boolean_options[i].getAttribute('value') + '([&=]|$)'))) {
                boolean_options[i].selected = true;
            }
        }
        refreshBooleanOptions(true);

        reload();
    })();
    </script>
</body>

</html>